<!DOCTYPE HTML>
<html>
<head>
    <!-- twitter bootstrap CSS stylesheet - not required by cornerstone -->
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #cacheInfo {
            word-wrap: break-word;
        }
    </style>
</head>
<body>
<div class="container">

<h1>
WebGL Example
</h1>

This is a work-in-progress example of WebGL use in cornerstone

<br>
<br>

<div class="row">
    <div class="col-xs-2">
        <ul class="list-group">
            <a id="int16" class="list-group-item">Int 16</a>
            <a id="uint16" class="list-group-item">UInt16</a>
            <a id="uint8" class="list-group-item">UInt8</a>
            <a id="RGB" class="list-group-item">RGB</a>
        </ul>
        <label for="invert">Invert <input id="invert" type="checkbox"></input></label>
        <a id="loseContext" class="btn btn-danger">Lose Context</a>
        <a id="addToCache" class="btn btn-primary">Add to cache</a>
        <p id="cacheInfo"></p>
    </div>
    <div class="col-xs-6">
        <div style="width:512px;height:512px;position:relative;display:inline-block;color:white;"
             oncontextmenu="return false"
             class='cornerstone-enabled-image'
             unselectable='on'
             onselectstart='return false;'
             onmousedown='return false;'>
            <div id="dicomImage"
                 style="width:512px;height:512px;top:0px;left:0px; position:absolute;">
            </div>
        </div>
        <div style="width:512px;height:512px;position:relative;display:inline-block;color:white;"
             oncontextmenu="return false"
             class='cornerstone-enabled-image'
             unselectable='on'
             onselectstart='return false;'
             onmousedown='return false;'>
            <div id="dicomImage2"
                 style="width:512px;height:512px;top:0px;left:0px; position:absolute;">
            </div>
        </div>
    </div>
</div>

</div>
</body>

<!-- cornerstone depends on jQuery so it must be loaded first-->
<script src="../jquery.min.js"></script>

<script src="webgl-debug.js"></script>
 
<!-- include the cornerstone library -->
<script src="../../dist/cornerstone.js"></script>

<!-- include special code for these examples which provides images -->
<script src="../dicomParser.js"></script>
<script src="../cornerstoneWADOImageLoader.js"></script>
<script src="../cornerstoneWebImageLoader.js"></script>

<script src="../cornerstoneMath.min.js"></script>
<script src="../cornerstoneTools.js"></script>
<script src="../hammer.min.js"></script>

<script src="../exampleImageIdLoader.js"></script>
<script src="../cornerstoneTestImageLoader.js"></script>

<script>

    $(document).ready(function() {
        // UInt16 Image generated via CornerstoneTestImageLoader
        var rampImageId = "ramp://"+256+","+256 +"," + 16;
        //var imageId = rampImageId;

        // CR
        //var imageId = 'dicomweb:http://cornerstonetech.org/images/ClearCanvas/CRStudy/1.3.51.5145.5142.20010109.1105627.1.0.1.dcm';
        //var imageId = 'dicomweb:http://jpx.jfpb.net/data/raw.dcm';
        //var imageId= 'dicomweb:http://cornerstonetech.org/images/ClearCanvas/DXStudy/1.2.840.113619.2.67.2158294438.16324010109084338.243.dcm';
        
        // Uncomment the next line to load a uint8 greyscale image
        var imageId = 'example://1';

        var imageId2 = 'example://2';
        
        // Uncomment the next line to load an RGB image
        //var imageId = 'https://upload.wikimedia.org/wikipedia/commons/7/7d/Renal_Cell_Carcinoma.jpg';
        
        var element = document.getElementById('dicomImage');


        // setup handlers before we display the image
        function onImageRendered(e, eventData) {
            // set the canvas context to the image coordinate system
            cornerstone.setToPixelCoordinateSystem(eventData.enabledElement, eventData.canvasContext);

            $('#topright').text("Render Time:" + eventData.renderTimeInMs + " ms");
            $('#bottomleft').text("WW/WL:" + Math.round(eventData.viewport.voi.windowWidth) + "/" + Math.round(eventData.viewport.voi.windowCenter));
            $('#bottomright').text("Zoom:" + eventData.viewport.scale.toFixed(2));

        }
        $(element).on("CornerstoneImageRendered", onImageRendered);

        $("#RGB").on('click', function() {
            loadImage('https://upload.wikimedia.org/wikipedia/commons/7/7d/Renal_Cell_Carcinoma.jpg');
        })

        $("#uint8").on('click', function() {
            loadImage('example://1');
        })

        $("#int16").on('click', function() {
            loadImage('dicomweb:http://jpx.jfpb.net/data/raw.dcm');
        })

        $("#uint16").on('click', function() {
            loadImage(rampImageId);
        })

        $("#invert").on('change', function() {
            var viewport = cornerstone.getViewport(element);
            viewport.invert = this.checked;
            cornerstone.setViewport(element, viewport);
        })

        $("#loseContext").on('click', function(e) {
            e.preventDefault();
            var canvas = cornerstone.webGL.renderer.getRenderCanvas();
            canvas.loseContext();
        })

        $("#addToCache").on('click', function(e) {
            e.preventDefault();
            var num = Math.ceil(Math.random() * 1000)
            rampImageId = "ramp://"+1000+","+num +"," + 16;
            console.log(rampImageId);
            loadImage(rampImageId);
            var cacheInfo = cornerstone.webGL.textureCache.getCacheInfo();
            console.log(cacheInfo);
            $("#cacheInfo").text(JSON.stringify(cacheInfo));
        })

        // Useful for testing textureCache.
        // cornerstone.webGL.textureCache.setMaximumSizeBytes(10000000);

        function loadImage(imageId) {
            cornerstone.loadImage(imageId).then(function(image) {
                cornerstone.displayImage(element, image);
                var viewport = cornerstone.getDefaultViewportForImage(element, image);
                cornerstone.setViewport(element, viewport);
            });
        }

        cornerstone.webGL.debug = true;
        cornerstone.enable(element, cornerstone.webGL.renderer.render);
        //cornerstone.enable(element, "WebGL");

        cornerstoneTools.mouseInput.enable(element);
        cornerstoneTools.touchInput.enable(element);
        cornerstoneTools.mouseWheelInput.enable(element);

        var element2 = document.getElementById('dicomImage2');
        cornerstone.enable(element2, cornerstone.webGL.renderer.render);
        //cornerstone.enable(element, "WebGL");

        cornerstoneTools.mouseInput.enable(element2);
        cornerstoneTools.touchInput.enable(element2);
        cornerstoneTools.mouseWheelInput.enable(element2);

        cornerstone.loadImage(imageId).then(function(image) {
            console.log(image);

            cornerstone.displayImage(element, image);

            // Enable mouse controls
            cornerstoneTools.wwwc.activate(element, 1);
            cornerstoneTools.pan.activate(element, 2);
            cornerstoneTools.zoom.activate(element, 4);
            cornerstoneTools.zoomWheel.activate(element);

            // Enable touch controls
            cornerstoneTools.wwwcTouchDrag.activate(element);
            cornerstoneTools.panMultiTouch.activate(element);
            cornerstoneTools.zoomTouchPinch.activate(element);
        });

        cornerstone.loadImage(imageId2).then(function(image) {
            console.log(image);

            cornerstone.displayImage(element2, image);

            // Enable mouse controls
            cornerstoneTools.wwwc.activate(element2, 1);
            cornerstoneTools.pan.activate(element2, 2);
            cornerstoneTools.zoom.activate(element2, 4);
            cornerstoneTools.zoomWheel.activate(element2);

            // Enable touch controls
            cornerstoneTools.wwwcTouchDrag.activate(element2);
            cornerstoneTools.panMultiTouch.activate(element2);
            cornerstoneTools.zoomTouchPinch.activate(element2);
        });
    });

</script>
</html>